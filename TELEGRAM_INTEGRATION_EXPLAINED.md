# Интеграция Telegram: Объяснение

## Текущая ситуация

### 1. **Веб-авторизация (Telegram Widget)** ✅ Работает
- **Что делает**: Позволяет пользователю авторизоваться на сайте через Telegram
- **Как работает**:
  - Пользователь нажимает "Login with Telegram" на сайте
  - Открывается Telegram OAuth popup
  - Пользователь подтверждает в Telegram
  - Сервер валидирует данные через Telegram Bot API
  - Создается сессия на сервере
  - Имя пользователя отображается в сайдбаре

- **Токен**: Использует `AICHAT_TELEGRAM_BOT_TOKEN` (или `TELEGRAM_BOT_TOKEN` как fallback)
- **Где используется**: `packages/server/src/api/auth/telegram.ts`

### 2. **Telegram Bot Plugin (`@elizaos/plugin-telegram`)** ❌ Не активен
- **Что делает**: **НЕ создает бота** (бот уже создан через BotFather), а **подключается** к существующему боту:
  - Подключается к Telegram Bot API используя токен
  - Начинает **слушать** сообщения от пользователей в Telegram
  - Отвечает на команды (например, `/start`, `/help`)
  - Может генерировать ответы через LLM
  - Обрабатывает естественный язык

- **Аналогия**: 
  - Бот в Telegram = телефон (уже создан через BotFather)
  - Плагин = приложение, которое отвечает на звонки (подключается к телефону)

- **Когда загружается**: Автоматически, если установлен `TELEGRAM_BOT_TOKEN`
- **Где используется**: В `metasiberian-agent/src/character.ts` (строка 37)

## Почему плагин не используется?

Сейчас мы используем `AICHAT_TELEGRAM_BOT_TOKEN` вместо `TELEGRAM_BOT_TOKEN`, чтобы:
- Избежать автозагрузки плагина `@elizaos/plugin-telegram`
- Предотвратить конфликты между веб-авторизацией и ботом

**НО это не обязательно!** Можно использовать оба одновременно.

## Как это должно работать вместе

### Вариант 1: Один токен для обоих (рекомендуется)

```
TELEGRAM_BOT_TOKEN=8581479820:AAExSOxUrhpGMecalu9DwmdCkoL_RZANxT8
```

**Что произойдет:**
1. ✅ Плагин `@elizaos/plugin-telegram` загрузится автоматически
2. ✅ Бот начнет слушать сообщения в Telegram
3. ✅ Веб-авторизация продолжит работать (использует тот же токен)

**Преимущества:**
- Один токен для всего
- Пользователь может авторизоваться и на сайте, и в боте
- Бот может отвечать на команды и сообщения
- Можно добавить кастомные команды (например, `/profile`, `/me`)

**Как это работает:**
- Плагин создает Service, который **подключается** к существующему боту через Telegram Bot API
- Использует токен для авторизации и начала прослушивания сообщений
- Веб-авторизация использует тот же токен для валидации данных
- Они не конфликтуют, потому что:
  - Плагин **слушает входящие сообщения** в Telegram (long polling или webhook)
  - Веб-авторизация **валидирует данные** через API (одноразовые запросы)
  
**Важно**: Бот уже создан в Telegram (через BotFather). Плагин просто "оживляет" его, заставляя отвечать на сообщения.

### Вариант 2: Два разных токена (если нужна изоляция)

```
AICHAT_TELEGRAM_BOT_TOKEN=8581479820:AAExSOxUrhpGMecalu9DwmdCkoL_RZANxT8  # Для веб-авторизации
TELEGRAM_BOT_TOKEN=8581479820:AAExSOxUrhpGMecalu9DwmdCkoL_RZANxT8          # Для бота
```

**Когда использовать:**
- Если хотите разделить функционал
- Если используете разные боты для разных целей

## Что можно добавить

### 1. Кастомные команды бота

Можно добавить команды, которые будут работать в боте:

```typescript
// Пример: команда /profile
// Пользователь пишет в боте: /profile
// Бот отвечает: "Ваш профиль: [имя], [username], [ID]"
```

### 2. Связь веб-аккаунта с ботом

- Пользователь авторизуется на сайте → создается сессия
- Пользователь пишет в боте → бот может получить информацию о пользователе из сессии
- Можно показать информацию о веб-аккаунте через бота

### 3. Команды для получения информации

- `/me` - показать информацию о текущем пользователе
- `/profile` - показать профиль
- `/link` - связать Telegram аккаунт с веб-аккаунтом

## Рекомендация

**Использовать один токен для обоих:**

1. Установить `TELEGRAM_BOT_TOKEN` в Render.com
2. Удалить `AICHAT_TELEGRAM_BOT_TOKEN` (или оставить как fallback)
3. Плагин автоматически загрузится
4. Бот начнет работать
5. Веб-авторизация продолжит работать

**Результат:**
- ✅ Пользователь авторизуется на сайте
- ✅ Пользователь может писать боту в Telegram
- ✅ Бот отвечает на команды и сообщения
- ✅ Можно добавить кастомные команды для получения информации о пользователе

## Следующие шаги

1. Включить плагин (установить `TELEGRAM_BOT_TOKEN`)
2. Добавить кастомные команды для бота (например, `/me`, `/profile`)
3. Связать веб-сессии с Telegram ID пользователя
4. Позволить боту получать информацию о пользователе из веб-сессий

